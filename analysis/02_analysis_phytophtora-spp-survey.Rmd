---
title: "Analysis Phytophthora spp. survey"
author: "Daniel Cerritos"
date: "4/24/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
# install.packages("pacman")
# install.packages(c("googleway", "ggrepel","ggspatial", "libwgeom", "sf", "rnaturalearth", 
# "rnaturalearthdata","hagis", "corrplot", "Hmisc", "drc", "rgeos", "scales"))
pacman::p_load(tidyverse, here, sf, maps, rnaturalearth, rnaturalearthdata, 
               cowplot, hagis, pander, lmerTest, ggResidpanel, emmeans, broom, 
               Hmisc, corrplot, drc, scales, broom)
```

# Import data

```{r data, message=FALSE}
all_data <- list.files(here("output", "clean_data"), full.names = TRUE)
# samples collection
soil_samples <- read_csv(all_data[9])
plant_samples <- read_csv(all_data[8])
# identification of isolates
isolates_recovered <- read_csv(here("data", "all-isolates-in-data-base.csv"))
# pathotype
sojae <- read_csv(all_data[7])
sansomeana <- read_csv(all_data[6])
#aggressiveness
dry_weigth <- read_csv(all_data[1])
area_length <- read_csv(all_data[2])
agg_temperature <- read_csv(all_data[3]) 
# fungicide sensitivity 
fungicide <- read.csv(all_data[5])
```


# Sample collection

```{r soil samples}
# 2016-2017
soil_samples %>%
  group_by(year) %>% 
  count() %>% 
  pander

soil_samples$county %>%
  n_distinct() 
```

```{r plant samples}
# 2018
plant_samples$PC_ID %>% 
  n_distinct()

plant_samples$County %>%
  n_distinct()
```

```{r total counties}
county_soil <- soil_samples %>% 
  dplyr::select(county)

county_plant <- plant_samples %>% 
  dplyr::select(county = County)

rbind(county_soil, county_plant) %>% 
  n_distinct()
```

```{r samples data map}
# subset county data 
world <- ne_countries(scale = "medium", returnclass = "sf")
states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
counties <- st_as_sf(map("county", plot = FALSE, fill = TRUE))
counties <- subset(counties, grepl("illinois", counties$ID))

# convert to sf object
map_soil <- soil_samples %>% 
  filter(!sample_id == "16PR012") %>% # not from IL
  dplyr::select(year, long, lat) %>% 
  filter(!is.na(long))

map_soil <- st_as_sf(map_soil, coords = c("long", "lat"), 
                   crs = 4326, agr = "constant")

# change continuous data (plant samples) into categorical
plant_samples_county <- plant_samples %>% 
  group_by(PC_ID, County) %>% 
  count() %>% 
  filter(!is.na(County)) %>% 
  dplyr::select(county = County) %>% 
  group_by(county) %>% 
  count() 

map_plant <- plant_samples_county %>% 
  mutate(samples_categ = case_when(
    n <= 5 ~ "1-5", 
    n >= 6 & n <= 10 ~ "6-10",
    n >= 11 & n <= 15 ~ "11-15", 
  ))

# add counties coordinates to plant samples data
counties <- counties %>% 
  separate(ID, into = c("state", "county"), sep = ",")

map_plant$county <- tolower(map_plant$county)
map_plant <- left_join(counties, map_plant, by = "county")

# as factor for plotting
map_plant$samples_categ <- as.factor(map_plant$samples_categ)
map_plant$samples_categ <- factor(map_plant$samples_categ, 
                                  levels = c("1-5", 
                                             "6-10",                                  
                                             "11-15"))
map_soil$year <- as.factor(map_soil$year)
map_plant <- map_plant %>% 
  filter(!is.na(samples_categ))

```

## Figure 1

```{r sample map}
# samples collection map 
(figure_one <- ggplot() +
  geom_sf(data = counties, fill = NA) +
  geom_sf(data = map_plant, aes(fill = samples_categ) , alpha = 0.7) +
  geom_sf(data = map_soil, aes(shape = year),  size = 2) +
  coord_sf(xlim = c(-92, -87), ylim = c(36.5, 43), expand = FALSE) +
  scale_fill_manual(values = c("#bdd7e7", "#3182bd", "#08519c"), 
                    name = "Plant samples") +
  scale_shape_discrete(name = "Year") +
  theme_map()
)

# ggsave("figure1.tiff", plot = figure_one, dpi = 300, path = here("docs", "figure"))
```

# Identification of isolates

## Phytophthora spp isolates

```{r phytophtora isolates}
sequenced_isolates <-  isolates_recovered %>%
  filter(identification == "sequence")

phytophthora_isolates <- sequenced_isolates %>% 
  filter(species %in% c("Phytophthora sansomeana", "Phytophthora sojae")) 

phytophthora_isolates %>% 
  group_by(year) %>% 
  count()

phytophthora_isolates %>% 
  dplyr::select(county) %>% 
  n_distinct()

# soil samples
phytophthora_isolates %>% 
  filter(!year == 2018) %>% 
  dplyr::select(sample_id) %>% 
  n_distinct() 

# plant samples
phytophthora_isolates %>% 
  filter(year == 2018) %>% 
  dplyr::select(sample_id) %>% 
  n_distinct() 

phytophthora_isolates %>% 
  filter(year == 2018) %>% 
  group_by(source) %>% 
  count()

```

```{r phytophthora table}
phytophthora_table <- phytophthora_isolates %>% 
  dplyr::select(isolate_id,species, county, year) %>% 
  arrange(isolate_id)

phytophthora_table %>% pander()
```

## All isolates

```{r all isolates}
isolates_recovered$county %>%
  n_distinct()

isolates_recovered %>%
  group_by(identification) %>% 
  count() %>% 
  pander()
```

```{r sequenced isolates}
sequenced_isolates %>% 
  group_by(year) %>% 
  count() %>% 
  mutate(percentage = (n/97)) %>% 
  pander()

sequenced_isolates$county %>% 
  n_distinct()
```

```{r species collected, message=FALSE}
isolates_species <- sequenced_isolates %>% 
  dplyr::select(species) %>%
  group_by(species) %>% 
  count() %>%  
  mutate(genus = case_when(
    grepl("Phyto", species) ~ "Phytophthora spp.",
    grepl("Pyth", species) ~"Pythium spp.")) %>% 
  mutate(percentage = (n/97))

isolates_species %>% 
  group_by(genus) %>% 
  count() %>% 
  mutate(percentage = (n/97)) %>% 
  pander()
```

```{r species figure}
isolates_species %>% 
  ggplot(aes(x = reorder(species, percentage), y = percentage, fill = genus)) +
  geom_col(alpha = 0.6) +
  coord_flip() +
  labs(x = "", y = "Percent isolates recovered", 
       title = "Species indentified from Illinois ") +
  theme_minimal_vgrid() +
  theme(legend.position = "none",
        axis.text.y  = element_text(face = "italic")) +
  scale_fill_manual(values = c("#F8766D", "#BEBEBE")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), 
                     labels = percent_format()) 

```

Was phytophthora and pythium isolated from same sample?

```{r phytophthora and pythium}
sequenced_isolates %>%
  group_by(sample_id, species) %>% 
  count() %>% 
  arrange(n) %>%
  mutate(genus = case_when(
    grepl("Phyto", species) ~ "Phytophthora spp.",
    grepl("Pyth", species) ~"Pythium spp.")) %>% 
  ggplot(aes(x = sample_id, y = n, fill = genus)) +
  geom_col(alpha = 0.7) +
  coord_flip() +
  theme_minimal_vgrid() +
  scale_fill_manual(values = c("#F8766D", "#BEBEBE")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)))
```

```{r samples phyto and pythium }
sequenced_isolates %>%
  filter(sample_id %in% c("17PR013", "17PR009")) %>% 
  group_by(sample_id, species, county) %>% 
  count()
```

# Virulence assays: Pathotype determination

## Phytophthora sojae

```{r effective Rps, message=FALSE}
# two susceptible controls
sojae_control <- sojae %>% 
  filter(differential == "Williams") %>% 
  group_by(isolate_number, isolate_id, isolate_name, county, differential, gene) %>% 
  summarise(dead = sum(dead), 
            total = sum(total))

sojae <- sojae %>% 
  filter(!differential == "Williams")

sojae <- bind_rows(sojae_control, sojae)

sojae <- sojae %>% 
  mutate(percent.susceptible = (dead/total)*100)

hagis_args <- list(
  x = sojae,
  cutoff = 75,
  control = "rps",
  sample = "isolate_number",
  gene = "gene",
  perc_susc = "percent.susceptible"
)

# effective Rps
sojae_rps <- do.call(summarize_gene, hagis_args)
sojae_rps %>% pander()
```

```{r complexity}
complexities <- do.call(calculate_complexities, hagis_args)
# mean complexity
pander(summary(complexities))
```

## Figure 2

```{r fig 2, fig.height=5.7, fig.width=4.5, warning=FALSE}
effective_rps <- sojae_rps %>% 
  mutate(percent_pathogenic = percent_pathogenic/100) %>% # to use the scales format
  ggplot(aes(x = gene, y = percent_pathogenic)) +
  geom_col(alpha = 0.6, fill = "#F37B59") +
  labs(x = "Rps gene", 
       y = "Percent pathogenic") +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)), 
    labels = percent_format()) +
    theme_minimal_hgrid()

# Fig 3B
complexity_percent <- complexities$grouped_complexities %>% 
  mutate(percent = (frequency/21))

complexity_percent$complexity <- as.numeric(complexity_percent$complexity)

mean_complexity <- complexity_percent %>% 
  ggplot(aes(x = complexity, y = percent)) +
  geom_col(alpha = 0.6, fill = "#529EFF") + 
  geom_vline(xintercept = 6, linetype="dashed",  size = 1) +
  labs(x = "Complexity", 
       y = "Percent Isolates") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), 
                     labels = percent_format()) +
  scale_x_continuous(limits = c(1, 12), breaks = 1:12) +
  theme_minimal_hgrid() 

(figure_two <- plot_grid(effective_rps, mean_complexity, labels = "AUTO", ncol = 1))

# ggsave("figure2.tiff", plot = figure_two, dpi = 300, path = here("docs", "figure"), width = 4.5, height = 5.7)
```

```{r diversity indexes}
# diversity indexes
diversity <- do.call(calculate_diversities, hagis_args)
diversity %>% pander()
```

## Table 1 

```{r table 1}
pathotypes_by_isolate <- diversity$individual_pathotypes %>% 
  rename(isolate_number = Sample) %>% 
  arrange(isolate_number)

isolates_ids <- phytophthora_table %>% 
  filter(species == "Phytophthora sojae") %>% 
  arrange(isolate_id)

pahtotypes_isolate <- bind_cols(isolates_ids, pathotypes_by_isolate) %>% 
  dplyr::select(-isolate_number)

## add sansomeana isolates to table 1
sansomeana_table_one <- phytophthora_table %>% 
  filter(species == "Phytophthora sansomeana") %>% 
  mutate(Pathotype = NA)

table_one <- bind_rows(sansomeana_table_one, pahtotypes_isolate) %>% 
  arrange(species, year)

table_one %>% pander()
  
# write_csv(table_one, path = here("output", "results", "02_identification_phytophthora-isolates_table-1.csv"))
```

## Table 2

```{r pathotype}
# pathotypes

pathotype_frequency <- diversity$table_of_pathotypes %>% 
  mutate(Percentage = round((Frequency/16)*100))

pathotype_frequency <- pathotype_frequency %>% 
  arrange(Frequency) %>% 
  dplyr::select(Pathotype, Frequency, Percentage)

# write_csv(pathotype_frequency, here("output", "results", "02_pathotype-psojae_frequency-table.csv"))

pathotype_frequency %>% pander()
```

## Phytophthora sansomeana

```{r sansomena effective genes, fig.height=2.85, fig.width=4.5}
sansomeana <- sansomeana %>% 
  mutate(percent.susceptible = (dead/total)*100)

# having trouble to use hagis package for sansomeana data
# calculate manually
sansomeana_summ <- sansomeana %>% 
  group_by(isolate_id, differential, gene) %>% 
  summarise(percent_susceptible = mean(percent.susceptible))

sansomeana_summ %>% 
  filter(percent_susceptible > 75)
```

```{r save pathotype data}
# combine pathtoype and complexity results
isolates_complexity <- complexities$indvidual_complexities %>% 
  rename(isolate_number = sample, Complexity = N_samp)

isolates_pathotypes <- diversity$individual_pathotypes %>% 
  rename(isolate_number = Sample)

isolates_complexity$isolate_number <- as.numeric(isolates_complexity$isolate_number)
sojae_all <- left_join(isolates_complexity, isolates_pathotypes, by = "isolate_number")

add_isolate_id <- sojae[1:24, ]

sojae_pathotype <- left_join(sojae_all, add_isolate_id, by = "isolate_number") %>% 
  dplyr::select(isolate_number, isolate_id, Complexity, Pathotype)

# write_csv(sojae_pathotype, here("output", "results", "02_pathotype-psojae_results.csv"))
```

# Aggressiveness

```{r area and length}
# some pots had two images in experiment 1 because they did not fit
area_length <- area_length %>% 
  group_by(experiment, pot) %>% 
  summarise(length_in = mean(length_in), 
            area_in.2 = mean(area_in.2))

aggressiveness <- left_join(dry_weigth, area_length, 
                            by = c("experiment", "pot")) 

# results  are by pot, divide by germination to get mean by seedling
aggressiveness <- aggressiveness %>% 
  mutate(shoot_mg = shoot.mg/germination, 
         root_mg = root.mg/germination, 
         length_in = length_in/germination, 
         area_in.2 = area_in.2/germination) %>% 
  dplyr::select(-c(emergence, root.mg, shoot.mg))

# convert to SI units 
aggressiveness  <- aggressiveness %>%
  mutate(length_cm = length_in*2.54, 
         area_cm.2 = area_in.2*6.4516)

# write_csv(aggressiveness, here("output", "transform_data", "02_aggressiveness_transform.csv"))
```

## Exploratory plots 

```{r average temperature, message=FALSE}
agg_temperature <- agg_temperature %>% 
  mutate(room_temperature = (room_temperature-32) * 5/9)   # transform to Celsius
  
agg_temperature %>% 
group_by(experiment) %>% 
  summarise(min = min(room_temperature), 
            max = max(room_temperature), 
            mean = mean(room_temperature)) %>% 
  pander()
```

```{r temperature agg}
agg_temperature$time <- as.character(agg_temperature$time)
# filter to the hours they have in common 
agg_temperature_filtered <- agg_temperature %>% 
  filter(time %in% c("00:15:00", "08:15:00", "16:15:00"))

agg_temperature_filtered %>% 
  ggplot(aes(x = date, y = room_temperature, color = as.factor(experiment))) +
  geom_line(group = 1)  +
  facet_grid(~ as.factor(experiment), scales = "free_x") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none") 
```

```{r exp plot 1, warning=FALSE}
aggressiveness$experiment <- as.factor(aggressiveness$experiment)
aggressiveness$isolate <- as.factor(aggressiveness$isolate)
aggressiveness$species <- as.factor(aggressiveness$species)

exp_plot <- function(y) {
  ggplot(data = aggressiveness, aes(x = experiment, y = .data[[y]])) +
    geom_boxplot() +
    theme_minimal() +
    labs(x = "", 
         y = y) +
    theme(legend.position = "none")
  }

by_exp_shoot <- exp_plot("shoot_mg")
by_exp_dry <- exp_plot("root_mg")
by_exp_length <- exp_plot("length_cm")
by_exp_area <- exp_plot("area_cm.2")

plot_grid(by_exp_shoot, by_exp_dry, by_exp_length, by_exp_area)
```

```{r distribution, warning=FALSE, message=FALSE}
dis_shoot <- qplot(shoot_mg, data = aggressiveness) +
  theme_minimal()
dis_dry <- qplot(root_mg, data = aggressiveness) +
    theme_minimal()
dis_length <- qplot(length_cm, data = aggressiveness) +
  theme_minimal() # skew to the left, some transformation needed
dis_area <- qplot(area_cm.2, data = aggressiveness) +
  theme_minimal() # also skew

plot_grid(dis_shoot, dis_dry, dis_length, dis_area)
```

```{r log transform, warning=FALSE, message=FALSE, fig.height=3, fig.width=7.5}
dis_length_log <- qplot(log(length_cm), data = aggressiveness) +
  theme_minimal() 
dis_area_log <- qplot(log(area_cm.2), data = aggressiveness) +
  theme_minimal() 

plot_grid(dis_length_log, dis_area_log) #improves with log transformation
```

## Difference between species

```{r fm root length }
# not nesting isolate:species, isolates coded in a way there is no needed
# same coefficient estimates and p values without nesting
# log transformation for normality and slight difference in variances
fm_root_length <- lmer(log(length_cm) ~ species + isolate + (1|experiment), data = aggressiveness)
resid_panel(fm_root_length ) # diagnostic plots look fine
anova(fm_root_length )
emmeans(fm_root_length , ~ species, type = "response") %>% # back-transform estimates
  cld.emmGrid()
```

```{r fm root area}
fm_root_area <- lmer(log(area_cm.2) ~ species + isolate + (1|experiment), data = aggressiveness)
resid_panel(fm_root_area) # transformation also worked 
anova(fm_root_area)
emmeans(fm_root_area, ~ species, type = "response") %>% 
  cld.emmGrid()
```

```{r fm root dry}
fm_root_dry <- lmer(root_mg ~ species + isolate + (1|experiment), data = aggressiveness)
resid_panel(fm_root_dry) 
anova(fm_root_dry)
emmeans(fm_root_dry, ~ species) %>% 
  cld.emmGrid() 
```

```{r fm shoot dry}
fm_shoot_dry <- lmer(shoot_mg ~ species + isolate + (1|experiment), data = aggressiveness)
resid_panel(fm_shoot_dry) 
anova(fm_shoot_dry)
emmeans(fm_shoot_dry, ~ species) %>% 
  cld.emmGrid()
```

## Results summary

```{r effect sizes, message=FALSE}
# save means to see effect size
m_root_dry <- emmeans(fm_root_dry, ~ species) %>% 
  tidy() %>% 
  mutate(agg_parameter = "root dry", 
         relative_growth = (estimate/33.95000)*100) # relative growth compared to control

m_shoot_dry <- emmeans(fm_shoot_dry, ~ species) %>% 
  tidy() %>% 
  mutate(agg_parameter = "shoot dry", 
         relative_growth = (estimate/83.45671)*100)

m_root_length <- emmeans(fm_root_length , ~ species, type = "response") %>% 
  tidy() %>% 
  mutate(agg_parameter = "root length", 
         relative_growth = (response/84.7)*100) %>% 
  rename(estimate = response)

m_root_area <- emmeans(fm_root_area, ~ species, type = "response") %>% 
  tidy() %>% 
  mutate(agg_parameter = "root area", 
         relative_growth = (response/4.66)*100)%>% 
  rename(estimate = response)

agg_species_means <- rbind(m_root_dry, m_shoot_dry, 
                           m_root_length, m_root_area) %>% 
  mutate(reduction = 100-relative_growth )


agg_species_means %>% 
  dplyr::select(agg_parameter, species, relative_growth, reduction) %>% 
  filter(species %in% c("Phytophthora sansomeana", "Phytophthora sojae")) %>% 
  pander()
```

## Figure 3

```{r agg data}
# combine the two controls for plotting
aggressiveness_plots <- read_csv(here("output", "transform_data", "02_aggressiveness_transform.csv"))

aggressiveness_plots$species <- str_replace_all(aggressiveness_plots$species, 
                                          c("Control Agar" = "Control", 
                                            "Control None" = "Control", 
                                            "Phytophthora sojae" = "P. sojae", 
                                            "Phytophthora sansomeana" = "P. sansomeana")
                                          )
```

```{r fig 3, fig.height=5, fig.width=6,  warning=FALSE, message=FALSE}
fig_3A <- aggressiveness_plots %>% 
  ggplot(aes(x = species, y = length_cm, color =  species)) +
  geom_boxplot(alpha = 0.6) +
  geom_point(position = position_jitter(), alpha = 0.15, color = "gray50") +
  labs(x = "", 
       y = "Root length (cm)", 
       color = "") + 
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  stat_summary(fun.y="mean", geom="point", size=1.2,
                 position=position_dodge(width=0.75), color="black")


fig_3B <- aggressiveness_plots %>% 
  ggplot(aes(x = species, y = area_cm.2, color =  species)) +
  geom_boxplot(alpha = 0.6) +
  geom_point(position = position_jitter(), alpha = 0.15, color = "gray50") +
  labs(y = expression('Root area (cm'^2*')'), 
       x = "")  + 
  theme_bw() +
  theme(axis.text.x = element_blank())  +
  stat_summary(fun.y="mean", geom="point", size=1.2,
                 position=position_dodge(width=0.75), color="black")

fig_3C <- ggplot(data = aggressiveness_plots, aes(x = species, y = root_mg, color =  species)) +
  geom_boxplot(alpha = 0.8) +
  geom_point(position = position_jitter(), alpha = 0.15, color = "gray50") +
  labs(x = "", 
       y = "Root dry weigth (mg)") + 
  theme_bw() +
  theme(axis.text.x = element_blank())  +
  stat_summary(fun.y="mean", geom="point", size=1.2,
                 position=position_dodge(width=0.75), color="black")

fig_3D <- ggplot(data = aggressiveness_plots, aes(x = species, y = shoot_mg, color =  species)) +
  geom_boxplot(alpha = 0.8) +
  geom_point(position = position_jitter(), alpha = 0.15, color = "gray50") +
  labs(x = "", 
       y = "Shoot dry weigth (mg)") + 
  theme_bw() +
  theme(axis.text.x = element_blank())  +
  stat_summary(fun.y="mean", geom="point", size=1.2,
                 position=position_dodge(width=0.75), color="black")


figure_three_no_legend <- plot_grid(
  fig_3A + theme(legend.position="none"),
  fig_3B + theme(legend.position="none"),
  fig_3C + theme(legend.position="none"),
  fig_3D + theme(legend.position="none"), 
  labels = "AUTO" 
)

legend_three <- get_legend(fig_3A + theme(legend.position = "bottom"))

(figure_three <- plot_grid(figure_three_no_legend, legend_three, ncol = 1, rel_heights = c(1, 0.1)))

# ggsave("figure3.tiff", plot = figure_three, dpi = 300, path = here("docs", "figure"), width = 6, height = 5)
```

## Difference within species (between isolates)

```{r seperate data, message=FALSE}
# subset data by species
aggressiveness <- read_csv(here("output", "transform_data", "02_aggressiveness_transform.csv"))

sojae_aggressiveness <- aggressiveness %>% 
  filter(!species == "Phytophthora sansomeana")

sansomeana_aggressiveness <- aggressiveness %>% 
  filter(!species == "Phytophthora sojae")
```

### Phytophthora sojae

```{r sojae dry root}
fm_root_dry_sojae <- lmer(root_mg ~ isolate + (1|experiment), data = sojae_aggressiveness)
resid_panel(fm_root_dry_sojae) 
anova(fm_root_dry_sojae)
emmeans(fm_root_dry_sojae, ~ isolate) %>%  
  cld.emmGrid()

```

```{r shoot dry root}
fm_shoot_dry_sojae <- lmer(shoot_mg ~ isolate + (1|experiment), data = sojae_aggressiveness)
resid_panel(fm_shoot_dry_sojae) 
anova(fm_shoot_dry_sojae)
emmeans(fm_shoot_dry_sojae, ~ isolate) %>% 
  cld.emmGrid()
```

```{r length sojae}
# log transformation for normality and slight difference in variances
fm_root_length_sojae <- lmer(log(length_cm) ~ isolate + (1|experiment), data = sojae_aggressiveness)
resid_panel(fm_root_length_sojae) # diagnostic plots look fine
anova(fm_root_length_sojae)
emmeans(fm_root_length_sojae, ~ isolate, type = "response") %>% # back-transform estimates
  cld.emmGrid()
```

```{r area sojea}
# log transformation for normality and slight difference in variances
fm_root_area_sojae <- lmer(log(area_cm.2) ~ isolate + (1|experiment), data = sojae_aggressiveness)
resid_panel(fm_root_area_sojae) # diagnostic plots look fine
anova(fm_root_area_sojae)
emmeans(fm_root_area_sojae, ~ isolate, type = "response") %>% # back-transform estimates
  cld.emmGrid()
```

```{r save agg means, message=FALSE}
m_root_dry_sojae <- emmeans(fm_root_dry_sojae, ~ isolate) %>% 
  tidy() %>% 
  mutate(agg_parameter = "Root dry weigth")

m_shoot_dry_sojae <- emmeans(fm_shoot_dry_sojae, ~ isolate) %>% 
  tidy() %>% 
  mutate(agg_parameter = "Shoot dry weigth")

m_root_length_sojae <- emmeans(fm_root_length_sojae, ~ isolate, type = "response") %>% 
  tidy() %>% 
  mutate(agg_parameter = "Root length") %>% 
  rename(estimate = response)

m_root_area_sojae <- emmeans(fm_root_area_sojae, ~ isolate, type = "response") %>% 
  tidy() %>% 
  mutate(agg_parameter = "Root area") %>% 
  rename(estimate = response)

agg_sojae_means <- bind_rows(m_root_dry_sojae, m_shoot_dry_sojae,
                             m_root_length_sojae, m_root_area_sojae)

# add species to isolates
agg_sojae_means <- agg_sojae_means %>% 
  mutate(species = case_when(
    isolate == "Control None" ~ "Control None", 
    isolate == "Control Agar" ~ "Control Agar", 
    TRUE ~ "Phytophthora sojae"
      ))

# write_csv(agg_sojae_means, here("output", "results", "02_aggressiveness_sojae-means.csv"))
```

### Phytophthora sansomeana

```{r sansomeana dry root}
fm_root_dry_sansomeana <- lmer(root_mg ~ isolate + (1|experiment), data = sansomeana_aggressiveness)
resid_panel(fm_root_dry_sansomeana) 
anova(fm_root_dry_sansomeana)
emmeans(fm_root_dry_sansomeana, ~ isolate) %>% 
  cld.emmGrid()
```

```{r sansomeana dry shoot}
fm_shoot_dry_sansomeana <- lmer(shoot_mg ~ isolate + (1|experiment), data = sansomeana_aggressiveness)
resid_panel(fm_shoot_dry_sansomeana) 
anova(fm_shoot_dry_sansomeana)
emmeans(fm_shoot_dry_sansomeana, ~ isolate) %>% 
  cld.emmGrid()
```

```{r sansomeana length}
fm_root_length_sansomeana <- lmer(log(length_cm) ~ isolate + (1|experiment), data = sansomeana_aggressiveness)
resid_panel(fm_root_length_sansomeana) 
anova(fm_root_length_sansomeana)
emmeans(fm_root_length_sansomeana, ~ isolate, type = "response") %>% 
  cld.emmGrid()
```

```{r sansomeana area}
fm_root_area_sansomeana <- lmer(log(area_cm.2) ~ isolate + (1|experiment), data = sansomeana_aggressiveness)
resid_panel(fm_root_area_sansomeana) 
anova(fm_root_area_sansomeana)
emmeans(fm_root_area_sansomeana, ~ isolate, type = "response") %>% 
  cld.emmGrid()
```

save means

```{r save sansomeana agg means, message=FALSE}
m_root_dry_sansomeana <- emmeans(fm_root_dry_sansomeana, ~ isolate) %>% 
  tidy() %>% 
  mutate(agg_parameter = "Root dry weigth")

m_shoot_dry_sansomeana <- emmeans(fm_shoot_dry_sansomeana, ~ isolate) %>% 
  tidy() %>% 
  mutate(agg_parameter = "Shoot dry weigth")

m_root_length_sansomeana <- emmeans(fm_root_length_sansomeana, ~ isolate, type = "response") %>% 
  tidy() %>% 
  mutate(agg_parameter = "Root length") %>% 
  rename(estimate = response)

m_root_area_sansomeana <- emmeans(fm_root_area_sansomeana, ~ isolate, type = "response") %>% 
  tidy() %>% 
  mutate(agg_parameter = "Root area") %>% 
  rename(estimate = response)

agg_sansomeana_means <- bind_rows(m_root_dry_sansomeana, m_shoot_dry_sansomeana,
                             m_root_length_sansomeana, m_root_area_sansomeana)

# add species to isolates
agg_sansomeana_means <- agg_sansomeana_means %>% 
  mutate(species = case_when(
    isolate == "Control None" ~ "Control None sansomena", 
    isolate == "Control Agar" ~ "Control Agar sansomeana", 
    TRUE ~ "Phytophthora sansomeana"
      ))

# write_csv(agg_sansomeana_means, here("output", "results", "02_aggressiveness_sansomeana-means.csv"))
```

## Figure 4

```{r fig 4 parts, message=FALSE}
fig_4A <- aggressiveness_plots %>% 
  ggplot(aes(x = reorder (isolate, root_mg), y = root_mg, color = species)) + 
  coord_flip() +
  stat_summary(fun.data = "mean_se", aes(colour = species), alpha = 0.6) +
  geom_hline(yintercept = 23.5, linetype="dashed",  size = 0.7) +
  theme_minimal() +
  theme(legend.position = "none", 
        axis.text.y  = element_text(size = rel(0.95))) +
  labs(x = "",
       y = "Root dry weigth (mg)",
       color = "") 

fig_4B <- aggressiveness_plots %>% 
  ggplot(aes(x = reorder (isolate, shoot_mg), y = shoot_mg, color = species)) + 
  coord_flip() +
  stat_summary(fun.data = "mean_se", aes(colour = species), alpha = 0.6) +
  geom_hline(yintercept = 57.15, linetype="dashed",  size = 0.7) +
  theme_minimal() +
  theme(legend.position = "none", 
        axis.text.y  = element_text(size = rel(0.95))) +
  labs(x = "",
       y = "Shoot dry weigth (mg)",
       color = "") 

# use back-transform means from emmeans output
# means bit different from raw data, some missing data
means_sojae <- read_csv(here("output", "results", "02_aggressiveness_sojae-means.csv"))
means_sansomeana <- read_csv(here("output", "results", "02_aggressiveness_sansomeana-means.csv")) %>% 
  filter(!species == "Control Agar sansomeana", 
         !species == "Control None sansomena")

# combine the two for plotting
means_aggressiveness <- rbind(means_sojae, means_sansomeana) 

means_aggressiveness$species <- str_replace_all(means_aggressiveness$species, 
                                                c("Control Agar" = "Control", 
                                                  "Control None" = "Control", 
                                                  "Phytophthora sojae" = "P. sojae", 
                                                  "Phytophthora sansomeana" = "P. sansomeana")
                                                )

fig_4C <- means_aggressiveness %>% 
  filter(agg_parameter == "Root length") %>% 
  ggplot(aes(x = reorder (isolate, estimate), y = estimate, color = species)) + 
  coord_flip() +
  geom_pointrange(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  alpha = 0.6) +
  geom_hline(yintercept = 30.05, linetype="dashed",  size = 0.7) +
  theme_minimal() +
  theme(legend.position = "none", 
        axis.text.y  = element_text(size = rel(0.95))) +
  labs(x = "",
       y = "Root length (cm)",
       color = "") 

fig_4D <- means_aggressiveness %>% 
  filter(agg_parameter == "Root area") %>% 
  ggplot(aes(x = reorder (isolate, estimate), y = estimate, color = species)) + 
  coord_flip() +
  geom_pointrange(aes(ymin = estimate - std.error, ymax = estimate + std.error), 
                  alpha = 0.6) +
  geom_hline(yintercept = 1.7545, linetype="dashed",  size = 0.7) +
  theme_minimal() +
  theme(legend.position = "none", 
        axis.text.y  = element_text(size = rel(0.95))) +
  labs(x = "",
       y = expression('Root area (cm'^2*')'),
       color = "") 
```


```{r fig 4, fig.height= 8, fig.width=5}
figure_four_AB <- plot_grid(fig_4A, fig_4B, labels = c("A", "B"), nrow  = 1)
figure_four_CD <- plot_grid(fig_4C, fig_4D, labels = c("C", "D"), nrow  = 1)

figure_four_no_legend <- plot_grid(figure_four_AB, figure_four_CD, ncol = 1)

legend_four <- get_legend(fig_4A + theme(legend.position = "bottom"))

(figure_four <- plot_grid(figure_four_no_legend, legend_four, ncol = 1, rel_heights = c(1,0.04)))

# ggsave("figure4.tiff", plot = figure_four, dpi = 300, path = here("docs", "figure"), width = 5, height = 8)
```


# Fungicide sensitivity 

## Clean and transform data for analysis

```{r prepare fs data}
# eliminate NAs
# average colony measurements 
clean_fungicide <- fungicide %>% 
  filter(!is.na(length_a)) %>%  
  mutate(length.mm = (length_a + length_b)/2) 

# subtract the plug diameter
clean_fungicide <- clean_fungicide %>% 
  mutate(length.mm = case_when(
    length.mm > 0 ~ length.mm - 4, 
    TRUE ~ length.mm - 0
    )) %>% 
  filter(!length.mm < 0) # eliminate any negative values 

# mean growth of control plate (dose 0)
control_fungicide <- clean_fungicide %>% 
  filter(dose == 0, 
         !is.na(length.mm)) %>% 
  group_by(fungicide, experiment, isolate) %>% 
  summarise(control.mean = mean(length.mm)) 

clean_fungicide <- left_join(clean_fungicide, control_fungicide, by = c("fungicide",
                                                                        "experiment", 
                                                                        "isolate"))
# relative growth calculation
clean_fungicide <- clean_fungicide %>% 
  mutate(rel.growth = (length.mm/control.mean)*100)

# write_csv(clean_fungicide, here("output", "transform_data", "02_fungicide-sensitivity_transform.csv"))
```

## Filter isolates 

```{r filter fungicide}
# check if there are isolates with no EC50
# isolates with >50% rel growth in the higher dose 
no_EC50 <- clean_fungicide %>% 
  group_by(fungicide, experiment, isolate, dose) %>% 
  summarise(rel.growth = mean(rel.growth)) %>% 
  filter(fungicide %in% c("Mefenoxam",
                          "Metalaxyl", 
                          "Ethaboxam") & dose == 1 & rel.growth > 50, 
         fungicide == "Azoxystrobin" & dose == 10 & rel.growth > 50)

# check if there are isolates with hormetic effect
# >100% rel growth at lower dose
hormetic_isolates <- clean_fungicide %>% 
  group_by(fungicide, experiment, isolate, dose) %>% 
  summarise(rel.growth = mean(rel.growth)) %>% 
  filter(rel.growth > 100, 
         !dose == 0) %>% 
  dplyr::select(fungicide, experiment, isolate)

hormetic_isolates %>% 
  group_by(fungicide, experiment, isolate) %>% 
  n_distinct()

hormetic_data <- semi_join(clean_fungicide, hormetic_isolates, by = c("fungicide",
                                                                        "experiment", 
                                                                        "isolate"))
```

## Fit log logistic models

```{r fit log logistic models, warning=FALSE }
# fit log-logistic models with 3 and 4 parameters 
nest_fungicide <- clean_fungicide %>% 
  group_by(fungicide, experiment, isolate) %>% 
  nest()

fit_LL3 <- function(dataset){
  drm(rel.growth ~ dose, fct = LL.3(names = c("slope", "upper", "EC50")), data = dataset)
}

fit_LL4 <- function(dataset){
  drm(rel.growth ~ dose, fct = LL.4(names = c("slope", "lower", "upper", "EC50")), data = dataset)
}

log_models <- nest_fungicide %>% 
  mutate(ll3.model = purrr::map(data, fit_LL3), 
         ll4.model = purrr::map(data, fit_LL4), 
         ll3.fit = purrr::map(ll3.model, mselect), 
         ll4.fit = purrr::map(ll4.model, mselect) 
         )
# mselect did not work inside function, use it individually to extract model fit info
```

```{r select best model}
log_selection <- log_models %>% 
  dplyr::select(ll3.fit, ll4.fit) %>% 
  gather(ll3.fit, ll4.fit, key = "model", value = "model.fit") %>%   
  unnest_wider(model.fit)

# select based on lower AIC
log_selection %>% 
  dplyr::select(fungicide, isolate, model, IC) %>% 
  spread(model, IC) %>% 
  filter(ll3.fit < ll4.fit) %>% 
  n_distinct() 
```
From the 256 models fit (experiment, fungicide and isolation combination), only 66 had higher AIC value for 4 parameters model (LL.4)

```{r fit p values}
# lack of fit p-values 
log_selection %>% 
  filter(`Lack of fit` > 0.05) %>% 
  group_by(model)%>% 
  count() %>% 
  pander()
```

More non-significant p-values for lack of fit  for the 4 parameters model (LL.3).  
Overall, LL.4 model better fit for most isolates

```{r EC50s, message=FALSE}
# extract absolute EC50s from LL.4 model
abs_EC50 <- function(models){
  ED(models, respLev = c(50), type = "absolute", interval = "delta")
}

log_models <- log_models %>% 
  mutate(ll4.EC50 = purrr::map(ll4.model, abs_EC50))

log_EC50 <- log_models %>% 
  dplyr::select(ll4.EC50) %>% 
  unnest_wider(ll4.EC50) %>% 
  rename(EC50 = ...1  , 
         std.error = ...2 ,
         lower = ...3, 
         upper = ...4)
```


## Hormetic models
Fit hormetic models to data with hormetic effects.

```{r fit hormetic models, message=FALSE, warning=FALSE}
nest_hormetic <- hormetic_data %>% 
  group_by(fungicide, experiment, isolate) %>% 
  nest()

fit_CRS <- function(dataset){
  drm(rel.growth ~ dose, fct = CRS.4c(), data = dataset)
}

fit_BC4 <- function(dataset){
  drm(rel.growth ~ dose, fct = BC.4(), data = dataset)
}

# fit hormetic models and compared it to LL.4
hormetic_models <- nest_hormetic %>% 
  mutate(crs.model = purrr::map(data, fit_CRS),
         bc4.model = purrr::map(data, fit_BC4 ),
         crs.fit = purrr::map(crs.model, mselect), 
         bc4.fit = purrr::map(bc4.model, mselect)
         )
```

```{r hormetic model selection}
hormetic_selection <- hormetic_models %>% 
  dplyr::select(crs.fit, bc4.fit)

hormetic_selection <- hormetic_selection %>% 
  gather(crs.fit, bc4.fit,  key = "model", value = "model.fit") %>%   
  unnest_wider(model.fit)

# add LL4 fit 
hormetic_selection <- semi_join(log_selection, hormetic_isolates) %>% 
  filter(model == "ll4.fit") %>% 
  bind_rows(hormetic_selection) %>% 
  arrange(isolate, IC)

# best hormetic model
hormetic_selection %>% 
  dplyr::select(fungicide, experiment, isolate, model, IC) %>% 
  spread(model, IC) %>% 
  filter(crs.fit < bc4.fit) %>% 
  n_distinct()
  

```

111 hormetic models fit, only 13 had higher for BC.4

```{r lack of fit hormetic}
# compare hormetic models vs LL.4
hormetic_selection %>% 
  dplyr::select(fungicide, experiment, isolate, model, IC) %>% 
  spread(model, IC) %>% 
  filter(ll4.fit > bc4.fit) %>% 
  n_distinct()
  
hormetic_selection %>% 
  filter(`Lack of fit` > 0.05) %>% 
  group_by(model) %>% 
  count() %>% 
  pander()
```

overall bc4 better fit based on lower AIC
no lack of fit for ll4 for most isolates with hormetic effect

## Reproducibility of assay 

```{r both data}
# check if 95 CI of exp 1 includes EC50 of exp 2
log_EC50$experiment <- as.factor(log_EC50$experiment)
log_EC50$isolate <- as.factor(log_EC50$isolate)

log_EC50 %>% 
  filter(!isolate == "13") %>% # 95% CI too large for plotting
  ggplot(aes(x = isolate, y = EC50, color = experiment)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), 
                  position = position_jitterdodge()) +
  facet_wrap(~ fungicide, scales = "free_y") +
  theme_minimal() +
  panel_border()
```

Overall most EC50 of second experiment fall into the 95% CI of EC50 first. Experiment is repoducible so combine the data of both experiments. 

```{r LL.4 combine data, message=FALSE, warning=FALSE}
# fit LL.4 model with pooled data
nest_pooled <- clean_fungicide %>% 
  group_by(fungicide, isolate) %>% 
  nest() 

log_pooled <- nest_pooled %>% 
  mutate(ll4.model = purrr::map(data, fit_LL4),
         ll4.fit = purrr::map(ll4.model, mselect), 
         abs.EC50 = purrr::map(ll4.model, abs_EC50)
         ) 

pooled_EC50 <- log_pooled %>% 
  dplyr::select(abs.EC50) %>% 
  unnest_wider(abs.EC50) %>% 
  rename(EC50 = ...1  , 
         std_error = ...2 ,
         lower = ...3, 
         upper = ...4) 
```

## Combined data analysis

```{r pooled hormetic model, message=FALSE, warning=FALSE}
# fit pool hormetic model
nest_hormetic_pooled <- hormetic_data %>% 
  group_by(fungicide, isolate) %>% 
  nest() 

hormetic_pooled <- nest_hormetic_pooled %>% 
  filter(!fungicide == "ethaboxam") # not working abs_Ec50 come back

hormetic_pooled <- hormetic_pooled %>% 
  mutate(bc4.model = purrr::map(data, fit_BC4),
         bc4.fit = purrr::map(bc4.model, mselect),
         abs.EC50 = purrr::map(bc4.model, abs_EC50)
         )

hormetic_EC50 <- hormetic_pooled %>% 
  dplyr::select(abs.EC50) %>% 
  unnest_wider(abs.EC50) %>% 
  rename(EC50 = ...1  , 
         std_error = ...2 ,
         lower = ...3, 
         upper = ...4) %>% 
  mutate(model = "BC4")
```

```{r compare EC50, fig.height=3, fig.width=8}
# compare hormetic EC50 with LL4 
compare_EC50 <- semi_join(pooled_EC50, hormetic_isolates, by = c("fungicide", "isolate")) %>% 
  mutate(model = "LL4") 

compare_EC50 <- bind_rows(compare_EC50, hormetic_EC50)
compare_EC50 <- compare_EC50 %>% 
  arrange(fungicide, isolate)


compare_EC50$isolate <- as.factor(compare_EC50$isolate)

compare_EC50 %>% 
  filter(!fungicide == "ethaboxam") %>% # problem calculating EC50
  ggplot(aes(x = isolate, y = EC50, color = model)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), 
                  position = position_jitterdodge()) +
  facet_wrap(~ fungicide, scales = "free") +
  theme_minimal() +
  panel_border()
```

Lower EC50 for the hormetic models.

## save results 

```{r add id to isolates}
## add isolate ID and species
## filter isolates not used 
isolates_used <- table_one %>% 
  filter(isolate_id %in% c("16PR009.1", "16PR018B.1", "16PR024C.1", "16PR024C.2", 
                           "16PR027C.1", "17PR006L.1", "17PR009A.1", "17PR013G.3", 
                           "17PR018H.1", "18PR001", "18PR003", "18PR004", "18PR005", 
                           "18PR006", "18PR011", "18PR013")) %>% 
  dplyr::select(isolate_id, species, county) %>% 
  arrange(isolate_id)

# add isolate number, identification used in sensitivity assays
isolates_used$isolate <- seq.int(nrow(isolates_used)) 

# combine it with EC50 results
pooled_EC50_id <- right_join(pooled_EC50, isolates_used, by = "isolate")  

pooled_EC50_id <- pooled_EC50_id %>% 
  dplyr::select(fungicide, species, isolate_id, EC50, std_error, lower, upper, county)

pooled_EC50_id <- pooled_EC50_id %>% 
  arrange(fungicide)

compare_EC50$isolate <- as.integer(compare_EC50$isolate)
compare_EC50_id <- right_join(compare_EC50, isolates_used, by = "isolate") 
compare_EC50_id <- compare_EC50_id %>% 
  filter(!is.na(fungicide))

# write_csv(pooled_EC50_id, here("output", "results", "02_fungicide-sensitivity_EC50.csv"))
# write_csv(compare_EC50_id, here("output", "results", "02_fungicide-sensitivity_EC50_hormetic-isolates.csv"))

```

## Figure 6

```{r figure 5,fig.height=5, fig.width=5.5, message=FALSE}
fungicide_EC50 <- read_csv(here("output", "results", "02_fungicide-sensitivity_EC50.csv"))

EC50_plot <- fungicide_EC50  %>% 
  mutate(species = case_when(
    isolate %in% c(1, 5, 7:10, 14:16) ~ "P. sojae",
    TRUE ~ "P. sansomeana"
  ))

EC50_plot$fungicide <- str_replace_all(EC50_plot$fungicide, 
                                       c("azoxystrobin" = "Azoxystrobin", 
                                         "ethaboxam" = "Ethaboxam", 
                                         "mefenoxam" = "Mefenoxam", 
                                         "metalaxyl" = "Metalaxyl")
                                       )


(figure_five <- ggplot(EC50_plot, aes(x = EC50, fill = species)) +
  geom_histogram(alpha = 0.6, color = "white", bins = 10) +
  facet_wrap(~ fungicide, scales = "free_x") +
  labs(x = expression('EC'[50]*' (μg ml'^-1*')'), 
       y = "Frequency", 
       fill = "") +
  theme_minimal() +
  panel_border() +
  theme(strip.text = element_text(face = "bold", size = rel(1)), 
        panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(), 
        legend.position = "bottom") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) 
)

# ggsave("figure5.tiff", plot = figure_five, dpi = 300, path = here("docs", "figure"), width = 5, height = 5)
```
# Correlation between aggressiveness and complexity 

```{r commbine sojae data, message=FALSE}
# import saved results
sojae_pathotype <- read_csv(here("output", "results", "02_pathotype-psojae_results.csv"))
means_aggressiveness <- read_csv(here("output", "results", "02_aggressiveness_sojae-means.csv"))

sojae_complexity <- sojae_pathotype %>% 
  dplyr::select(isolate_id, Complexity)

sojae_aggressiveness <- means_aggressiveness %>% 
  filter(species == "Phytophthora sojae") %>% 
  dplyr::select(isolate_id = isolate, estimate, agg_parameter) %>% 
  spread(agg_parameter, estimate)

sojae_all_data <- left_join(sojae_complexity, sojae_aggressiveness, by = c("isolate_id")) 

# EC50 data
corr_EC50 <- fungicide_EC50 %>% 
  filter(species == "Phytophthora sojae") %>% 
  dplyr::select(isolate_id, fungicide, EC50)

corr_EC50 <- corr_EC50 %>% 
  spread(fungicide, EC50)

sojae_all_data_EC50 <- full_join(sojae_all_data, corr_EC50, by = "isolate_id")

```

```{r pearson correlation}
sojae_corr <- sojae_all_data_EC50 %>%
  dplyr::select(-isolate_id) %>%
  as.matrix() %>%
  rcorr(type = "pearson")

sojae_corr 
```

## Figure 5

```{r corr plot}
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(sojae_corr$r, method = "color", col = col(200),
         type = "upper", order = "hclust", number.cex = 1.5,
         addCoef.col = "black", # Add coefficient of correlation
         tl.col = "black", tl.srt = 90, # Text label color and rotation
         # Combine with significance
         p.mat = sojae_corr$P, sig.level = 0.05, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag = FALSE, tl.cex = 1)
```









```{r}
fungicide_EC50 %>% 
  group_by(fungicide, species) %>% 
  summarise(min_EC = min(EC50), 
            max_EC = max(EC50), 
            mean_EC = mean(EC50))
```


```{r}
fungicide_EC50 %>% 
  filter(fungicide == "azoxystrobin", 
         EC50 > 2) %>% 
  group_by(fungicide, species) %>% 
  summarise(min_EC = min(EC50), 
            max_EC = max(EC50), 
            mean_EC = mean(EC50))
```


```{r}
fungicide_EC50 %>% 
  filter(fungicide == "azoxystrobin", 
         EC50 > 2)

fungicide_EC50 %>% 
  filter(fungicide == "ethaboxam", 
         EC50 > 0.03)


fungicide_EC50 %>% 
  filter(fungicide == "metalaxyl", 
         EC50 > 0.07)
  
```

