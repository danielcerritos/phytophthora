---
title: "Analysis Phytophthora spp. survey"
author: "Daniel Cerritos"
date: "4/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
# install.packages(c("googleway", "ggrepel","ggspatial", "libwgeom", "sf", "rnaturalearth", "rnaturalearthdata", "hagis", "corrplot", "Hmisc", "drc"))
# devtools::install_github("yutannihilation/ggsflabel")
library(here)
library(tidyverse)
library(sf)
library(maps)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)
library(cowplot)
library(ggsflabel)
library(hagis)
library(pander)
library(lmerTest)
library(ggResidpanel)
library(emmeans)
library(broom)
library(Hmisc)
library(corrplot)
library(drc)
```

# Import data

```{r data}
(all.data <- list.files(here("output", "clean_data"), full.names = TRUE))
# samples collection
soil.samples <- read_csv(all.data[8])
plant.samples <- read_csv(all.data[7])
# identification of isolates
isolates.recovered <- read_csv(here("data", "all-isolates-in-data-base.csv"))
# pathotype
sojae <- read_csv(all.data[6])
sansomeana <- read_csv(all.data[5])
#aggressiveness
dry.weigth <- read_csv(all.data[1])
area.length <- read_csv(all.data[2])
# fungicide sensitivity 
fun.sens <- read.csv(all.data[4])
```

# Sample collection

```{r exp analysis}
# 2016-2017
soil.samples %>%
  group_by(year) %>% 
  count() 
soil.samples$county %>% 
  n_distinct() 

# 2018
plant.samples %>%
  count() 
plant.samples$county %>%
  n_distinct()
```

## Map

I use code from here: 
https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html 
https://www.r-graph-gallery.com/330-bubble-map-with-ggplot2.html

```{r samples map}
soil.samples <- soil.samples %>% 
  select(year, long, lat) %>% 
  filter(!is.na(long))

# convert to sf object
soil.samples <- st_as_sf(soil.samples, coords = c("long", "lat"), 
                   crs = 4326, agr = "constant")

soil.samples$year <- as.factor(soil.samples$year)

# subset county data 
world <- ne_countries(scale = "medium", returnclass = "sf")
states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
counties <- st_as_sf(map("county", plot = FALSE, fill = TRUE))
counties <- subset(counties, grepl("illinois", counties$ID))

# add plant samples data
counties <- counties %>% 
  separate(ID, into = c("state", "county"), sep = ",")

# change continous data into categories 
plant.samples <- plant.samples %>% 
  group_by(county) %>% 
  count() %>% 
  mutate(samples = case_when(
    n <= 5 ~ "1 - 5", 
    n >= 6 & n <= 10 ~ "6 - 10",
    n >= 11 & n <= 15 ~ "11 - 15", 
    n >= 16 & n <= 20 ~ "16 - 20", 
  ))

plant.samples$county <- tolower(plant.samples$county)
all_data <- left_join(counties, plant.samples, by = "county")

# map 
ggplot(data = world) +
  geom_sf(data = states, fill = NA) + 
  geom_sf(data = all_data, aes(fill = samples), color = "black", alpha = 0.8) +
  geom_sf(data = soil.samples, aes(shape = year),  size = 2) +
  coord_sf(xlim = c(-92, -87), ylim = c(36.5, 43), expand = FALSE) +
  scale_fill_manual(values = c("#a1dab4", "#41b6c4", "#225ea8", "#2c7fb8")) 
  theme_map()
```

# Identification of isolates

```{r exp isolates}
isolates.recovered %>% 
  group_by(year, source) %>% 
  count()

isolates.recovered %>% 
  group_by(identification) %>% 
  count() 
```

##  Map

```{r map isolates}
# I added the coordinates manually, change code 
isolates <- isolates.recovered %>% 
  select(county, species) %>%  
  mutate(genus = case_when(
    grepl("Phyto", species) ~ "Phytophthora spp.",
    grepl("Pyth", species) ~"Pythium spp."))

isolates <- isolates %>% 
  filter(!is.na(county)) %>% 
  group_by(county, genus) %>% 
  count()

isolates <- isolates %>%  
  mutate(genus = case_when(
    grepl("Phyto", species) ~ "Phytophthora spp.",
    grepl("Pyth", species) ~ "Pythium spp."))

write.csv(isolates, here("output", "isolates-count-genus.csv"))

collection.map <- read_csv(here("output", "isolates-count-genus.csv"))
il_counties <- map_data("county", "illinois")

#counties labels 
phyto.conties <- collection.map %>% 
  filter(genus == "Phytophthora spp.")

ggplot() +
  geom_polygon(data = il_counties, aes(x = long, y = lat, group = group), 
               fill = "white", color = "grey50") +
  geom_point(data = collection.map, aes(x = long, y = lat, size = isolates, 
                                        color = genus)) +
  geom_text_repel(data=phyto.conties, aes(x=long, y=lat, label= county), size=5) +
  coord_map() +
  theme_map() 
```

```{r figure species collected}
isolates.summary <- isolates.recovered %>% 
  select(species) %>%
  group_by(species) %>% 
  count() %>%  
  mutate(genus = case_when(
    grepl("Phyto", species) ~ "Phytophthora spp.",
    grepl("Pyth", species) ~"Pythium spp.")) %>% 
  mutate(percentage = (n/182)*100)

isolates.summary %>% 
  ggplot(aes(x = reorder(species, percentage), y = percentage, fill = genus))+
  geom_col() +
  coord_flip() +
  theme_minimal_hgrid()+
  labs(y = "Isolates (%)", 
       x = "Species") +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)))+
  theme_minimal_hgrid()+
  panel_border() +
  theme(legend.position = "none", 
        panel.grid.major.y = element_line(linetype = "dotted", 
                                          color = "grey80")) +
  scale_fill_manual(values = c("#FF6A6A", "#BEBEBE"))
```

# Pathotype

## Phytophthora sojae

```{r effective Rps}
# two susceptible controls
williams <- sojae %>% 
  filter(differential == "Williams") %>% 
  group_by(isolate_number, isolate_id, isolate_name, county, differential, gene) %>% 
  summarise(dead = sum(dead), 
            total = sum(total))

sojae <- sojae %>% 
  filter(!differential == "Williams")
sojae <- bind_rows(williams, sojae)
sojae <- sojae %>% 
  mutate(percent.susceptible = round((dead/total)*100))

hagis_args <- list(
  x = sojae,
  cutoff = 75,
  control = "rps",
  sample = "isolate_id",
  gene = "gene",
  perc_susc = "percent.susceptible"
)
# effective Rps
Rps.summary <- do.call(summarize_gene, hagis_args)
Rps.summary %>% 
  ggplot(aes(x = gene, y = percent_pathogenic)) +
  geom_col(fill = "#FF7256", alpha = 0.5) +
  theme_minimal_hgrid() +
  labs(x = "Rps gene", 
       y = "Percent pathogenic") +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05))) 
```

```{r complexity}
# mean complexity
complexities <- do.call(calculate_complexities, hagis_args)

complexity.percent <- complexities$grouped_complexities %>% 
  mutate(percent = (frequency/21)*100)

complexity.percent$complexity <- as.numeric(complexity.percent$complexity)
complexities$indvidual_complexities


complexity.percent %>% 
  ggplot(aes(x = complexity, y = percent)) +
  geom_col(fill = "#6495ED", alpha = 0.5) +
  theme_minimal_hgrid() +
  labs(x = "Complexity", 
       y = "Percent Isolates") +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05))) +
  scale_x_continuous(limits = c(1, 12), breaks = 1:12)

pander(summary(complexities))
```

```{r pathotype}
# diversity
do.call(calculate_diversities, hagis_args)
# pathotypes
diversities_table(diversity)
```

## Phytophthora sansomeana

```{r sansomena effective genes}
sansomeana <- sansomeana %>% 
  mutate(percent.susceptible = round((dead/total)*100))

sansomeana.rps <- summarize_gene(
  x = sansomeana,
  cutoff = 75,
  control = "rps",
  sample = "isolate_id",
  gene = "gene",
  perc_susc = "percent.susceptible"
)

sansomeana.rps %>% 
  ggplot(aes(x = gene, y = percent_pathogenic)) +
  geom_col(fill = "#FF7256", alpha = 0.5) +
  theme_minimal_hgrid() +
  labs(x = "Rps gene", 
       y = "Percent pathogenic") +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05))) 
```

# Aggressiveness

```{r area and length}
# some pots had two images in experiment 1 because they did it fit
area.length <- area.length %>% 
  group_by(experiment, pot) %>% 
  summarise(length_in = mean(length_in), 
            area_in.2 = mean(area_in.2))

aggressiveness <- left_join(dry.weigth, area.length, 
                            by = c("experiment", "pot")) 

# results  are by pot, divide by germination to get mean by seedling
aggressiveness <- aggressiveness %>% 
  mutate(shoot.mg = shoot.mg/germination, 
         root.mg = root.mg/germination, 
         length_in = length_in/germination, 
         area_in.2 = area_in.2/germination)
```

## Exploratory plots 

```{r exp plot 1}
aggressiveness$experiment <- as.factor(aggressiveness$experiment)
aggressiveness$isolate <- as.factor(aggressiveness$isolate)
aggressiveness$species <- as.factor(aggressiveness$species)

exp_plot <- function(y) {
  ggplot(data = aggressiveness, aes(x = experiment, y = .data[[y]])) +
    geom_boxplot(alpha = 0.6) +
    geom_point(aes(color =  experiment), position = position_jitter()) +
    theme_bw() +
    labs(x = "experiment", 
         y = y)
  }

exp_plot("shoot.mg")
exp_plot("root.mg")
exp_plot("length_in")
exp_plot("area_in.2")
```

```{r exp plot 2}
exp_plot_2 <- function(y) {
  ggplot(aggressiveness, aes(x = experiment, y = .data[[y]])) +
    geom_boxplot() +
    geom_point(aes(color =  experiment), position = position_jitter()) +
    facet_wrap(~species) +
    theme_bw()
}

exp_plot_2("root.mg")
exp_plot_2("shoot.mg")
exp_plot_2("length_in")
exp_plot_2("area_in.2")
```

```{r distribution}
qplot(shoot.mg, data = aggressiveness) +
  theme_bw()

qplot(root.mg, data = aggressiveness) +
  theme_bw()

qplot(length_in, data = aggressiveness) +
  theme_bw() # skew to the left, some transformation needed

qplot(area_in.2, data = aggressiveness) +
  theme_bw() # also skew
```

## Mix model and ANOVAs

```{r nesting}
aggressiveness <- aggressiveness %>% 
  mutate(species_isolate = paste(isolate, species, sep = "_")) # nest isolate in species
```

```{r fm root dry }
prueba <- aggressiveness %>% 
  filter(!species == "Control Agar", 
         !species == "Control None")
# experiment as random to account for variation between experiments 
fm.root.dry <- lmer(root.mg ~ species + species_isolate + (1|experiment), data = prueba)
resid_panel(fm.root.dry) # no assumptions violated 
anova(fm.root.dry)
```

```{r fm shoot dry }
fm.shoot.dry <- lmer(shoot.mg ~ species + species_isolate + (1|experiment), data = aggressiveness)
resid_panel(fm.shoot.dry) # most of the data points fall into the line 
anova(fm.root.dry)
```

```{r fm root length }
# log transformation for normality and slight difference in variances
fm.root.length <- lmer(log(length_in) ~ species + species_isolate + (1|experiment), data = aggressiveness)
resid_panel(fm.root.length) # transformation worked 
anova(fm.root.length)
```

```{r fm root area}
fm.root.area <- lmer(log(area_in.2) ~ species + species_isolate + (1|experiment), data = aggressiveness)
resid_panel(fm.root.area) # transformation also worked 
anova(fm.root.length)
```

## Differences between species 

```{r mean separation species}
emmeans(fm.root.dry, ~species) %>% 
  cld.emmGrid()

emmeans(fm.shoot.dry, ~species) %>% 
  cld.emmGrid()

emmeans(fm.root.length, ~species) %>% 
  cld.emmGrid()

emmeans(fm.root.area, ~species) %>% 
  cld.emmGrid()
```

```{r plot species}
species_plot <- function(y) {
  ggplot(data = aggressiveness, aes(x = species, y = .data[[y]])) +
    geom_boxplot(alpha = 0.6) +
    geom_point(aes(color =  experiment), position = position_jitter()) +
    theme_bw() +
    labs(x = "experiment", 
         y = y)
}

species_plot("root.mg")
species_plot("shoot.mg")
species_plot("length_in")
species_plot("area_in.2")
```

## Differences within species (between isolates)

```{r mean separation isolates}
emmeans(fm.root.dry, ~species_isolate) %>% 
  plot(comparisons = TRUE)

emmeans(fm.shoot.dry, ~species_isolate) %>% 
  plot(comparisons = TRUE)

emmeans(fm.root.length, ~species_isolate) %>% 
  plot(comparisons = TRUE)

emmeans(fm.root.area, ~species_isolate) %>% 
  plot(comparisons = TRUE)

```

```{r save means}

m.root.dry <- emmeans(fm.root.dry, ~species_isolate) %>% 
  tidy() %>% 
  select(species_isolate, 
         root.mg = estimate, 
         r.low = conf.low, 
         r.high = conf.high) 

m.shoot.dry <- emmeans(fm.shoot.dry, ~species_isolate) %>% 
  tidy()%>% 
  select(species_isolate, 
         shoot.mg = estimate, 
         s.low = conf.low, 
         s.high = conf.high) 

m.root.length <- emmeans(fm.root.length, ~species_isolate) %>% 
  tidy()%>% 
  select(species_isolate, 
         length.in = estimate, 
         l.low = conf.low, 
         l.high = conf.high) 

m.root.area <- emmeans(fm.root.area, ~species_isolate) %>% 
  tidy()%>% 
  select(species_isolate, 
         area.in2 = estimate, 
         a.low = conf.low, 
         a.high = conf.high) 

m.dry <- left_join(m.root.dry , m.shoot.dry, by = c("species_isolate")) 
m.scan <- left_join(m.root.length, m.root.area,by = c("species_isolate")) 

means.aggressiveness <- left_join(m.dry, m.scan, by = c("species_isolate")) %>% 
  separate(species_isolate, into = c("isolate", "species"), sep = "_")
```

https://ggplot2.tidyverse.org/reference/geom_linerange.html code from to 
add calculated CIs and means from emmeans 


```{r isolates plot}
ggplot(aggressiveness, aes(x = reorder(isolate_id, root.mg), y = root.mg, color = species)) + 
  geom_point(alpha = 0.2) +
  geom_jitter(colour = "gray50", alpha = 0.3, width = 0.1) +
  stat_summary(fun.data = "mean_cl_boot", 
               position = position_dodge(width = 0.5), 
               alpha = 0.7) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.position = "bottom") +
  labs(x = "Isolate ID", 
       y = "Mean root dry weigth (mg)") 

```

## Correlation between aggressiveness and complexity 

```{r correlations}
# add complexity results
iso.complexity <- as.data.frame(complexities$indvidual_complexities) %>% 
  rename(isolate = sample, complexity = N_samp)

sojae.agg <- means.aggressiveness %>% 
  filter(species == "Phytophthora sojae") %>% 
  select(isolate, root.mg, shoot.mg, length.in, area.in2) 

sojae.all <- left_join(sojae.agg, iso.complexity, by = c("isolate"))

sojae.corr <- sojae.all %>%
  select(-isolate) %>%
  as.matrix() %>%
  rcorr(type = "pearson")

corrplot(sojae.corr$r, method = "number")
```

# Fungicide Sensitivity 

```{r check variances}
# remember to do some plots for the SHAM pilot
fun.sens$experiment <- as.factor(fun.sens$experiment)
fun.sens %>% 
  ggplot(aes(x = experiment, y = length_a)) +
  geom_boxplot() +
  facet_wrap(~ fungicide) +
  theme_bw()
  
fun.sens %>% 
  ggplot(aes(x = fungicide, y = length_a)) +
  geom_boxplot() +
  facet_wrap(~ experiment) +
  theme_bw()
# variances look similar across experiments, azoxystrobin different from the rest of fungicides 
# look papers what they do to check variances 
```

```{r prepare fs data}
fun.sens <- fun.sens %>% 
  filter(!is.na(length_a)) %>%  # eliminate NAs
  mutate(length.mm = (length_a + length_b)/2) # average colony measurements 

fun.sens <- fun.sens %>% 
  mutate(length.mm = case_when(
    length.mm > 0 ~ length.mm - 4, # subtract the plug diameter
    TRUE ~ length.mm - 0
  ))

# mean growth of control (dose 0)
dose0 <- fun.sens %>% 
  filter(dose == 0, 
         !is.na(length.mm)) %>% 
  group_by(fungicide, experiment, isolate) %>% 
  summarise(dose0.mean = mean(length.mm)) 

fun.sens <- left_join(fun.sens, dose0, by = c("fungicide", "experiment", "isolate"))

# relative growth: growth/mean growth control 
fun.sens <- fun.sens %>% 
  mutate(rel.growth = case_when(
    dose == 0 ~ 100, 
    TRUE ~ (length.mm/dose0.mean)*100, 
  ))

# isolates with >50% growth in higher dose 
no.EC50 <- fun.sens %>% 
  filter(fungicide %in% c("Mefenoxam", "Metalaxyl", "Ethaboxam") & dose == 1 & rel.growth >= 50, 
         fungicide == "Azoxystrobin" & dose == 10 & rel.growth >= 50) # no insensitive isolates

hormesis <- fun.sens %>% 
  filter(rel.growth > 100) # multiple isolates with hormetic effect

```

```{r fit log logistic models }
# eliminate NAs
# average colony measurements 
fun.sens <- fun.sens %>% 
  filter(!is.na(length_a)) %>%  
  mutate(length.mm = (length_a + length_b)/2) 

# subtract the plug diameter
fun.sens <- fun.sens %>% 
  mutate(length.mm = case_when(
    length.mm > 0 ~ length.mm - 4, 
    TRUE ~ length.mm - 0
  ))

# mean growth of control plate (dose 0)
control <- fun.sens %>% 
  filter(dose == 0, 
         !is.na(length.mm)) %>% 
  group_by(fungicide, experiment, isolate) %>% 
  summarise(dose0.mean = mean(length.mm)) 

fun.sens <- left_join(fun.sens, control, by = c("fungicide", 
                                              "experiment", 
                                              "isolate"))




combine <- lm(length.mm ~ experiment, data = fun.sens)
summary(combine)

plot(combine)


# relative growth calculation
fun.sens <- fun.sens %>% 
  mutate(rel.growth = case_when(
    dose == 0 ~ 100, 
    TRUE ~ (length.mm/dose0.mean)*100, 
  ))

# check if there are isolates with no EC50
# isolates with >50% rel growth in the higher dose 
no.EC50 <- fun.sens %>% 
  filter(fungicide %in% c("Mefenoxam", "Metalaxyl", "Ethaboxam") & dose == 1 & rel.growth >= 50, 
         fungicide == "Azoxystrobin" & dose == 10 & rel.growth >= 50) # no insensitive isolates

# check if there are isolates with hormetic effect
# >100% rel growth at lower concentration 
hormesis <- fun.sens %>% 
  filter(rel.growth > 100) 
  
# fit a log-logistic model with 3 and 4 parameters 
nest_data <- fun.sens %>% 
  group_by(fungicide, experiment, isolate) %>% 
  nest()

LL3_model <- function(dataset){
  drm(length.mm ~ dose, fct = LL.3(names = c("slope", "upper", "EC50")), data = dataset)
}

LL4_model <- function(dataset){
  drm(length.mm ~ dose, fct = LL.4(names = c("slope", "lower", "upper", "EC50")), data = dataset)
}

prueba <- nest_data %>% 
  mutate(ll3.model = purrr::map(data, LL3_model), 
         ll4.model = purrr::map(data, LL4_model), 
         ll3.fit = purrr::map(ll3.model, mselect), 
         ll4.fit = purrr::map(ll4.model, mselect)
         )

select.model <- prueba %>% 
  dplyr::select(ll3.fit, ll4.fit)

select.model <- select.model %>% 
  gather(ll3.fit, ll4.fit, key = "model", value = "model.fit") %>%   
  unnest_wider(model.fit)

select.model %>% 
  arrange(fungicide, isolate)
```

